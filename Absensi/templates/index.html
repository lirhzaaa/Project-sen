<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Attendance Records</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Global Styles */
        body {
            background-color: #f8f9fa; /* Light background for better readability */
            font-family: Arial, sans-serif;
        }
        
        .navbar {
            margin-bottom: 20px;
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }

        .container {
            background-color: #fff; /* White background for the content area */
            border-radius: 8px; /* Rounded corners for the container */
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
        }

        .btn-container {
            display: flex;
            gap: 15px; /* Increased space between buttons */
            margin-bottom: 20px; /* Space below the buttons */
        }

        .btn-container .btn {
            font-size: 14px; /* Consistent font size for buttons */
        }

        .modal-content {
            border-radius: 8px; /* Rounded corners for modal */
        }

        .modal-body button {
            margin-bottom: 10px; /* Space between modal buttons */
        }

        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Increased space between filter items */
            margin-bottom: 20px;
        }

        .filter-form .form-group {
            flex: 1;
            min-width: 200px; /* Increased minimum width for better readability */
        }

        /* Table Styles */
        #records table {
            width: 100%;
            border-collapse: collapse; /* Collapse borders for cleaner look */
        }

        #records th, #records td {
            padding: 12px; /* Increased padding for cells */
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid #e0e0e0; /* Subtle border for row separation */
        }

        #records th {
            background-color: #e9ecef; /* Light gray background for headers */
            font-weight: bold; /* Bold text for headers */
        }

        #records td input[type="text"].form-control {
            max-width: 150px; /* Slightly wider input fields */
        }

        #records .form-control {
            height: auto;
            padding: 8px; /* Adjusted padding for better fit */
        }
        
        .filter-form select.form-control {
            height: auto; /* Adjust height to better fit content */
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
function fetchRecords() {
    const idFilter = document.getElementById('idFilter').value;
    const userIdFilter = document.getElementById('userIdFilter').value;
    const attendanceFilter = document.getElementById('attendanceFilter').value;
    const nameFilter = document.getElementById('nameFilter').value;
    const lateFilter = document.getElementById('lateFilter').value;

    fetch(`../fetch_records.php?id=${idFilter}&user_id=${userIdFilter}&attendance=${attendanceFilter}&name=${nameFilter}&is_late=${lateFilter}`)
        .then(response => response.text())
        .then(text => {
            try {
                const data = JSON.parse(text);
                console.log('Fetched data:', data); // Log the fetched data
                const groupedData = groupByWeek(data);
                displayRecords(groupedData);
            } catch (error) {
                console.error('Error parsing JSON:', error);
                console.error('Response text:', text); // Log the raw response
            }
        })
        .catch(error => console.error('Error fetching records:', error));
}

function groupByWeek(records) {
    const grouped = {};
    records.forEach(record => {
        const week = getWeekOfYear(new Date(record.datetime));
        if (!grouped[week]) {
            grouped[week] = [];
        }
        grouped[week].push(record);
    });

    const uniqueRecords = {};
    Object.keys(grouped).forEach(week => {
        const weekRecords = grouped[week];
        const userMap = {};
        weekRecords.forEach(record => {
            if (!userMap[record.user_id]) {
                userMap[record.user_id] = [];
            }
            userMap[record.user_id].push(record);
        });

        Object.keys(userMap).forEach(userId => {
            const userRecords = userMap[userId];
            if (userRecords.length > 1) {
                userRecords.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            }
            uniqueRecords[`${week}_${userId}`] = userRecords[0];
        });
    });

    return Object.values(uniqueRecords);
}

function getWeekOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 1);
    const diff = date - start + ((start.getTimezoneOffset() - date.getTimezoneOffset()) * 60000);
    const oneWeek = 604800000;
    const weekNumber = Math.ceil(diff / oneWeek);
    return weekNumber;
}

function displayRecords(data) {
    let recordsDiv = document.getElementById('records');
    let table = '<table class="table table-bordered"><tr><th>ID</th><th>User ID</th><th>Full Name</th><th>Date Time</th><th>Check Type</th><th>Attendance</th><th>Attendance Type</th><th>Late</th><th>Actions</th></tr>';

    const weekRecords = {};
    data.forEach((record, index) => {
        const week = getWeekOfYear(new Date(record.datetime));
        if (!weekRecords[week]) {
            weekRecords[week] = [];
        }
        weekRecords[week].push(record);
    });

    Object.keys(weekRecords).forEach((week, weekIndex) => {
        table += `<tr><td colspan="9" style="text-align:center; font-weight:bold;">--Minggu ${parseInt(week)}--</td></tr>`;

        weekRecords[week].forEach((record, recordIndex) => {
            const id = (recordIndex % 5) + 1;
            let attendanceIn = record.attendance_in === '-' ? '-' : 'Present';
            let attendanceOut = record.attendance_out === '-' ? '-' : 'Present';
            let finalAttendance = record.datetime_out ? attendanceOut : '-';
            
            // Logic to determine if the record is late based on the current time
            let isLateIn = isLate(new Date(record.datetime));
            let isLateOut = record.datetime_out ? isLate(new Date(record.datetime_out)) : false;

            // Record untuk 'Check In'
            table += `<tr>
                <td>${id}</td>
                <td><input type="text" value="${record.user_id}" id="user_id_${record.id}_in" class="form-control"></td>
                <td>${record.full_name}</td>
                <td><input type="text" value="${record.datetime}" id="datetime_${record.id}" class="form-control datetimepicker"></td>
                <td>Check In</td>
                <td>
                    <select id="attendance_${record.id}_in" class="form-control">
                        <option value="0" ${attendanceIn == '-' ? 'selected' : ''}>-</option>
                        <option value="1" ${attendanceIn == 'Present' ? 'selected' : ''}>Present</option>
                    </select>
                </td>
                <td>
                    <select id="attendance_type_${record.id}_in" class="form-control">
                        <option value="1" ${record.attendance_type_in == 'Fingerprint' ? 'selected' : ''}>Fingerprint Method</option>
                        <option value="16" ${record.attendance_type_in == 'Face Recognition' ? 'selected' : ''}>Face Recognition Method</option>
                    </select>
                </td>
                <td>${isLateIn ? 'Late' : 'On Time'}</td>
                <td>
                    <button onclick="saveRecord(${record.id}, 'in')" class="btn btn-primary">Save Changes</button>
                    <button onclick="deleteRecord(${record.id})" class="btn btn-danger">Delete</button>
                </td>
            </tr>`;

            // Record untuk 'Check Out'
            table += `<tr>
                <td></td>
                <td><input type="text" value="${record.user_id}" id="user_id_${record.id}_out" class="form-control"></td>
                <td>${record.full_name}</td>
                <td><input type="text" value="${record.datetime_out || ''}" id="datetime_${record.id}_out" class="form-control datetimepicker"></td>
                <td>Check Out</td>
                <td>
                    <select id="attendance_${record.id}_out" class="form-control">
                        <option value="0" ${attendanceOut == '-' ? 'selected' : ''}>-</option>
                        <option value="1" ${attendanceOut == 'Present' ? 'selected' : ''}>Present</option>
                    </select>
                </td>
                <td>
                    <select id="attendance_type_${record.id}_out" class="form-control">
                        <option value="1" ${record.attendance_type_out == 'Fingerprint' ? 'selected' : ''}>Fingerprint Method</option>
                        <option value="16" ${record.attendance_type_out == 'Face Recognition' ? 'selected' : ''}>Face Recognition Method</option>
                    </select>
                </td>
                <td>${isLateOut ? 'Late' : '-'}</td>
                <td>
                    <button onclick="saveRecord(${record.id}, 'out')" class="btn btn-primary">Save Changes</button>
                    <button onclick="deleteRecord(${record.id})" class="btn btn-danger">Delete</button>
                </td>
            </tr>`;
        });
    });

    table += '</table>';
    recordsDiv.innerHTML = table;

    flatpickr(".datetimepicker", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
    });
}

function isLate(date) {
    const checkInTime = new Date(date);
    const threshold = new Date(checkInTime);
    threshold.setHours(9, 30, 0, 0); // Set threshold to 09:30:00
    return checkInTime > threshold;
}




        function updateAttendance(id) {
            let checkType = document.getElementById(`check_type_${id}`).value;
            let attendanceSelect = document.getElementById(`attendance_${id}`);
            if (checkType == 0) { // Check In
                attendanceSelect.value = 1; // Present
            } else if (checkType == 1) { // Check Out
                attendanceSelect.value = 0; // -
            }
        }

        function saveRecord(id, type) {
            let user_id = document.getElementById(`user_id_${id}_${type}`).value;
            let datetime = document.getElementById(`datetime_${id}_${type}`).value;
            let check_type = type;
            let attendance = document.getElementById(`attendance_${id}_${type}`).value;
            let attendance_type = document.getElementById(`attendance_type_${id}_${type}`).value;

            let formData = new FormData();
            formData.append('action', 'edit');
            formData.append('id', id);
            formData.append('user_id', user_id);
            formData.append('datetime', datetime);
            formData.append('check_type', check_type);
            formData.append('attendance', attendance);
            formData.append('attendance_type', attendance_type);

            fetch('../manage_record.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetchRecords(); 
                } else {
                    console.error('Server error:', data.message);
                }
            })
            .catch(error => console.error('Request failed:', error));
        }


        function editRecord(id, type) {
            let user_id = document.getElementById(`user_id_${id}_${type}`).value;
            let datetime = document.getElementById(`datetime_${id}_${type}`).value;
            let check_type = type;
            let attendance = document.getElementById(`attendance_${id}_${type}`).value;
            let attendance_type = document.getElementById(`attendance_type_${id}_${type}`).value;

            let formData = new FormData();
            formData.append('action', 'edit');
            formData.append('id', id);
            formData.append('user_id', user_id);
            formData.append('datetime', datetime);
            formData.append('check_type', check_type);
            formData.append('attendance', attendance);
            formData.append('attendance_type', attendance_type);

            fetch('../manage_records.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetchRecords(); 
                } else {
                    console.error('Server error:', data.message);
                }
            })
            .catch(error => console.error('Request failed:', error));
        }

        function deleteRecord(id) {
            let formData = new FormData();
            formData.append('action', 'delete');
            formData.append('id', id);

            fetch('../manage_record.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        fetchRecords();
                    } else {
                        console.error(data.message);
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.error('Response text:', text); // Log the raw response
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteRecords(type) {
            let formData = new FormData();
            formData.append('action', 'delete_all');
            formData.append('type', type);

            fetch('../manage_records.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        fetchRecords();
                    } else {
                        console.error(data.message);
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.error('Response text:', text); // Log the raw response
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function autoCorrect() {
            console.log('Auto Correct Records button clicked');
            fetch('../manage_records.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=auto_correct'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auto Correct Response:', data);
                if (data.status === 'success') {
                    fetchRecords();
                } else {
                    console.error(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('Document loaded, fetching records...');
            fetchRecords();
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="img/logo.png" alt="Company Logo" style="height: 40px; margin-right: 10px;">
            Attendance System
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Manage Attendances</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="manage_users.html">Manage Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="form.html">Upload File</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Manage Attendance Records</h1>

        <div class="btn-container">
            <a href="../export.php" class="btn btn-success">Export to Excel</a>
            <button class="btn btn-danger" data-toggle="modal" data-target="#deleteModal">
                Delete Records
            </button>
            <!-- <button class="btn btn-warning" onclick="autoCorrect()">Auto Correct Records</button> -->
        </div>

        <!-- Delete Records Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Delete Records</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Select the type of records you want to delete:</p>
                        <button class="btn btn-danger" onclick="deleteRecords('today')">Delete Today's Records</button>
                        <button class="btn btn-danger" onclick="deleteRecords('all')">Delete All Records</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <form class="filter-form">
            <div class="form-group">
                <label for="idFilter">Filter by ID:</label>
                <input type="text" id="idFilter" class="form-control">
            </div>
            <div class="form-group">
                <label for="userIdFilter">Filter by User ID:</label>
                <input type="text" id="userIdFilter" class="form-control">
            </div>
            <div class="form-group">
                <label for="attendanceFilter">Filter by Attendance Type:</label>
                <select id="attendanceFilter" class="form-control">
                    <option value="">All</option>
                    <option value="1">Fingerprint Method</option>
                    <option value="16">Face Recognition Method</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nameFilter">Filter by Name:</label>
                <input type="text" id="nameFilter" class="form-control">
            </div>
            <div class="form-group">
                <label for="lateFilter">Filter by Late Status:</label>
                <select id="lateFilter" class="form-control">
                    <option value="">All</option>
                    <option value="1">Late</option>
                    <option value="0">On Time</option>
                </select>
            </div>
            <button type="button" onclick="fetchRecords()" class="btn btn-primary">Filter</button>
        </form>

        <div id="records"></div>
    </div>
</body>
</html>
