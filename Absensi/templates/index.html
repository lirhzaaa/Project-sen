<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Attendance Records</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .btn-container {
            display: flex;
            gap: 10px; /* Space between buttons */
            margin-top: 20px; /* Space above the buttons */
        }
        .modal-body button {
            margin-bottom: 10px; /* Space between modal buttons */
        }
        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-form .form-group {
            flex: 1;
            min-width: 150px;
        }
        /* Table Styling */
        #records table {
            width: 100%; /* Ensure the table fills the container */
        }

        #records th, #records td {
            padding: 10px; /* Add padding to cells */
            text-align: left; /* Align text to the left */
            vertical-align: middle; /* Vertically center text in cells */
            border-bottom: 1px solid #ddd; /* Add a subtle border to separate rows */
        }

        #records th {
            background-color: #f2f2f2; /* Light gray background for headers */
        }

        #records input[type="text"].form-control {
            max-width: 120px; /* Limit the width of user_id input fields */
        }

        #records input[type="text"].form-control {
            width: 150px; 
        }
        #records .form-control {
            height: auto; /* Adjust height to better fit content */
            padding: 5px; /* Reduce padding for a more compact look */
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        function fetchRecords() {
            const idFilter = document.getElementById('idFilter').value;
            const userIdFilter = document.getElementById('userIdFilter').value;
            const attendanceFilter = document.getElementById('attendanceFilter').value;
            const nameFilter = document.getElementById('nameFilter').value;
            const lateFilter = document.getElementById('lateFilter').value;

            fetch(`../fetch_records.php?id=${idFilter}&user_id=${userIdFilter}&attendance=${attendanceFilter}&name=${nameFilter}&is_late=${lateFilter}`)
                .then(response => response.text())
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        console.log('Fetched data:', data); // Log the fetched data
                        displayRecords(data);
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        console.error('Response text:', text); // Log the raw response
                    }
                })
                .catch(error => console.error('Error fetching records:', error));
        }

        function displayRecords(data) {
         let recordsDiv = document.getElementById('records');
         let table = '<table class="table table-bordered"><tr><th>ID</th><th>User ID</th><th>Full Name</th><th>Date Time</th><th>Check Type</th><th>Attendance</th><th>Attendance Type</th><th>Late</th><th>Actions</th></tr>';

                data.forEach((record, index) => {
                    // Calculate the display ID
                    let displayId = (index % 5) + 1;

                    // Insert separator after every 5 records
                    if (index % 5 === 0 && index !== 0) {
                        table += `<tr><td colspan="9" style="text-align:center; font-weight:bold;">--Minggu ${Math.floor(index / 5) + 1}--</td></tr>`;
                    }

                    table += `<tr>
                                <td>${displayId}</td>
                                <td><input type="text" value="${record.user_id}" id="user_id_${record.id}" class="form-control"></td>
                                <td>${record.full_name}</td>
                                <td><input type="text" value="${record.datetime}" id="datetime_${record.id}" class="form-control datetimepicker"></td>
                                <td>
                                    <select id="check_type_${record.id}" class="form-control" onchange="updateAttendance(${record.id})">
                                        <option value="0" ${record.check_type == 0 ? 'selected' : ''}>Check In</option>
                                        <option value="1" ${record.check_type == 1 ? 'selected' : ''}>Check Out</option>
                                    </select>
                                </td>
                                <td>
                                    <select id="attendance_${record.id}" class="form-control">
                                        <option value="0" ${record.attendance == 'Absent' ? 'selected' : ''}>Absent</option>
                                        <option value="1" ${record.attendance == 'Present' ? 'selected' : ''}>Present</option>
                                    </select>
                                </td>
                                <td>
                                    <select id="attendance_type_${record.id}" class="form-control">
                                        <option value="1" ${record.attendance_type == 'Fingerprint' ? 'selected' : ''}>Fingerprint Method</option>
                                        <option value="16" ${record.attendance_type == 'Face Recognition' ? 'selected' : ''}>Face Recognition Method</option>
                                    </select>
                                </td>
                                <td>${record.is_late == 1 ? 'Yes' : 'No'}</td>
                                <td>
                                    <button onclick="editRecord(${record.id})" class="btn btn-primary">Save Changes</button>
                                    <button onclick="deleteRecord(${record.id})" class="btn btn-danger">Delete</button>
                                </td>
                            </tr>`;
                });
                table += '</table>';
                recordsDiv.innerHTML = table;

                flatpickr(".datetimepicker", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
    });
}




        function updateAttendance(id) {
            let checkType = document.getElementById(`check_type_${id}`).value;
            let attendanceSelect = document.getElementById(`attendance_${id}`);
            if (checkType == 0) { // Check In
                attendanceSelect.value = 1; // Present
            } else if (checkType == 1) { // Check Out
                attendanceSelect.value = 0; // Absent
            }
        }

        function editRecord(id) {
            let user_id = document.getElementById(`user_id_${id}`).value;
            let datetime = document.getElementById(`datetime_${id}`).value;
            let check_type = document.getElementById(`check_type_${id}`).value;
            let attendance = document.getElementById(`attendance_${id}`).value;
            let attendance_type = document.getElementById(`attendance_type_${id}`).value;

            let formData = new FormData();
            formData.append('action', 'edit');
            formData.append('id', id);
            formData.append('user_id', user_id);
            formData.append('datetime', datetime);
            formData.append('check_type', check_type);
            formData.append('attendance', attendance);
            formData.append('attendance_type', attendance_type);

            fetch('../manage_records.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetchRecords(); 
                } else {
                    console.error('Server error:', data.message);
                }
            })
            .catch(error => console.error('Request failed:', error));
        }

        function deleteRecord(id) {
            let formData = new FormData();
            formData.append('action', 'delete');
            formData.append('id', id);

            fetch('../manage_record.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        fetchRecords();
                    } else {
                        console.error(data.message);
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.error('Response text:', text); // Log the raw response
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteRecords(type) {
            let formData = new FormData();
            formData.append('action', 'delete_all');
            formData.append('type', type);

            fetch('../manage_records.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        fetchRecords();
                    } else {
                        console.error(data.message);
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.error('Response text:', text); // Log the raw response
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function autoCorrect() {
            console.log('Auto Correct Records button clicked');
            fetch('../manage_records.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=auto_correct'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auto Correct Response:', data);
                if (data.status === 'success') {
                    fetchRecords();
                } else {
                    console.error(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('Document loaded, fetching records...');
            fetchRecords();
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="img/logo.png" alt="Company Logo" style="height: 40px; margin-right: 10px;">
            Attendance System
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Manage Attendances</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="manage_users.html">Manage Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="form.html">Upload File</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Manage Attendance Records</h1>

        <div class="btn-container">
            <a href="../export.php" class="btn btn-success">Export to Excel</a>
            <!-- Trigger Button for Modal -->
            <button class="btn btn-danger" data-toggle="modal" data-target="#deleteModal">
                Delete Records
            </button>
            <button class="btn btn-warning" onclick="autoCorrect()">Auto Correct Records</button>
        </div>

        <!-- Delete Records Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Delete Records</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Select the type of records you want to delete:</p>
                        <button class="btn btn-danger" onclick="deleteRecords('today')">Delete Today's Records</button>
                        <button class="btn btn-danger" onclick="deleteRecords('all')">Delete All Records</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <form class="filter-form">
            <div class="form-group">
                <label for="idFilter">Filter by ID:</label>
                <input type="text" id="idFilter" class="form-control">
            </div>
            <div class="form-group">
                <label for="userIdFilter">Filter by User ID:</label>
                <input type="text" id="userIdFilter" class="form-control">
            </div>
            <div class="form-group">
                <label for="attendanceFilter">Filter by Attendance Type:</label>
                <select id="attendanceFilter" class="form-control">
                    <option value="">All</option>
                    <option value="1">Fingerprint Method</option>
                    <option value="16">Face Recognition Method</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nameFilter">Filter by Name:</label>
                <input type="text" id="nameFilter" class="form-control">
            </div>
            <div class="form-group">
                <label for="lateFilter">Filter by Late Status:</label>
                <select id="lateFilter" class="form-control">
                    <option value="">All</option>
                    <option value="1">Late</option>
                    <option value="0">On Time</option>
                </select>
            </div>
            <button type="button" onclick="fetchRecords()" class="btn btn-primary">Filter</button>
        </form>

        <div id="records"></div>
    </div>
</body>
</html>
