<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Statistics</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 300px;
        }
        .combined-chart-container {
            display: flex;
            justify-content: space-between;
        }
        .table-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="img/logo.png" alt="Company Logo" style="height: 40px; margin-right: 10px;">
            Attendance System
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Manage Attendances</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="manage_users.html">Manage Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="form.html">Upload File</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 id="user-name">User Statistics</h1>
        <div class="card-container">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Records</h5>
                    <p class="card-text" id="totalRecords"></p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Present</h5>
                    <p class="card-text" id="present"></p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Absent</h5>
                    <p class="card-text" id="absent"></p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Late</h5>
                    <p class="card-text" id="late"></p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">On Time</h5>
                    <p class="card-text" id="onTime"></p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Late Statistics</h5>
                    <p class="card-text" id="lateStatistics"></p>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <div class="combined-chart-container">
                    <div class="chart-wrapper">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dateWiseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h2>Attendance Records</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>Full Name</th>
                        <th>Date Time</th>
                        <th>Check Type</th>
                        <th>Attendance</th>
                        <th>Attendance Type</th>
                        <th>Late</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body">
                    <!-- Records will be injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">

    <script>
        $(function () {
            $('.datetimepicker').datetimepicker();
        });

        function fetchUserStatistics() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');

            if (!userId) {
                document.getElementById('attendance-records').innerHTML = '<p class="text-danger">User ID is missing.</p>';
                return;
            }

            fetch(`../fetch_statistics.php?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('attendance-records').innerHTML = `<p class="text-danger">${data.error}</p>`;
                    } else {
                        document.getElementById('user-name').textContent = `${data.user.full_name}'s User Statistics`;

                        document.getElementById('totalRecords').textContent = data.attendance.length;
                        const presentCount = data.attendance.filter(record => record.attendance > 0).length;
                        const absentCount = data.attendance.filter(record => record.attendance == 0).length;
                        const lateCount = data.attendance.filter(record => record.attendance > 0 && new Date(record.datetime).getHours() >= 10).length;
                        const onTimeCount = presentCount - lateCount;
                        document.getElementById('present').textContent = presentCount;
                        document.getElementById('absent').textContent = absentCount;
                        document.getElementById('late').textContent = lateCount;
                        document.getElementById('onTime').textContent = onTimeCount;

                        const lateStatistics = `
                            Total Late: ${lateCount}<br>
                            <ul>
                                <li>15-30 minutes late: ${data.attendance.filter(record => record.attendance > 0 && new Date(record.datetime).getMinutes() >= 15 && new Date(record.datetime).getMinutes() < 30).length}</li>
                                <li>30-60 minutes late: ${data.attendance.filter(record => record.attendance > 0 && new Date(record.datetime).getMinutes() >= 30 && new Date(record.datetime).getMinutes() < 60).length}</li>
                                <li>More than an hour late: ${data.attendance.filter(record => record.attendance > 0 && new Date(record.datetime).getMinutes() >= 60).length}</li>
                            </ul>
                        `;
                        document.getElementById('lateStatistics').innerHTML = lateStatistics;

                        const ctx = document.getElementById('attendanceChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: ['Present', 'Absent', 'Late', 'On Time'],
                                datasets: [{
                                    data: [presentCount, absentCount, lateCount, onTimeCount],
                                    backgroundColor: ['#4CAF50', '#FF5733', '#FFC107', '#2196F3'],
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Attendance Statistics'
                                    }
                                }
                            }
                        });

                        const dateWiseStats = data.attendance.reduce((acc, record) => {
                            const date = new Date(record.datetime).toISOString().split('T')[0];
                            if (!acc[date]) {
                                acc[date] = { late_count: 0, on_time_count: 0 };
                            }
                            if (record.attendance > 0 && new Date(record.datetime).getHours() >= 10) {
                                acc[date].late_count++;
                            } else if (record.attendance > 0) {
                                acc[date].on_time_count++;
                            }
                            return acc;
                        }, {});

                        const dateWiseLabels = Object.keys(dateWiseStats);
                        const lateData = dateWiseLabels.map(date => dateWiseStats[date].late_count);
                        const onTimeData = dateWiseLabels.map(date => dateWiseStats[date].on_time_count);

                        const dateWiseCtx = document.getElementById('dateWiseChart').getContext('2d');
                        new Chart(dateWiseCtx, {
                            type: 'line',
                            data: {
                                labels: dateWiseLabels,
                                datasets: [
                                    {
                                        label: 'Late Attendance',
                                        data: lateData,
                                        borderColor: '#FF5733',
                                        fill: false
                                    },
                                    {
                                        label: 'On Time Attendance',
                                        data: onTimeData,
                                        borderColor: '#4CAF50',
                                        fill: false
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Date Wise Attendance'
                                    }
                                }
                            }
                        });

                        const tableBody = document.getElementById('attendance-table-body');
                        tableBody.innerHTML = data.attendance.map(record => `
                            <tr>
                                <td>${record.id}</td>
                                <td><input type="text" value="${record.user_id}" id="user_id_${record.id}" class="form-control"></td> 
                                <td>${data.user.full_name}</td>
                                <td><input type="text" value="${record.datetime}" id="datetime_${record.id}" class="form-control datetimepicker"></td>
                                <td>
                                    <select id="check_type_${record.id}" class="form-control">
                                        <option value="0" ${record.check_type == 0 ? 'selected' : ''}>Check In</option>
                                        <option value="1" ${record.check_type == 1 ? 'selected' : ''}>Check Out</option>
                                    </select>
                                </td>
                                <td>
                                    <select id="attendance_${record.id}" class="form-control">
                                        <option value="0" ${record.attendance == 'Absent' ? 'selected' : ''}>Absent</option>
                                        <option value="1" ${record.attendance == 'Present' ? 'selected' : ''}>Present</option>
                                    </select>
                                </td>
                                <td>
                                    <select id="attendance_type_${record.id}" class="form-control">
                                        <option value="1" ${record.attendance_type == 'Fingerprint' ? 'selected' : ''}>Fingerprint Method</option>
                                        <option value="16" ${record.attendance_type == 'Face Recognition' ? 'selected' : ''}>Face Recognition Method</option>
                                    </select>
                                </td>
                                <td>${record.is_late == 1 ? 'Yes' : 'No'}</td>
                                <td>
                                    <button onclick="editRecord(${record.id})" class="btn btn-primary">Save Changes</button>
                                    <button onclick="deleteRecord(${record.id})" class="btn btn-danger">Delete</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(error => {
                    document.getElementById('attendance-records').innerHTML = `<p class="text-danger">Failed to load user statistics. Please try again later.</p>`;
                    console.error('Error fetching user statistics:', error);
                });
        }

        function editRecord(id) {
            // Implement save logic here
            const userId = document.getElementById(`user_id_${id}`).value;
            const datetime = document.getElementById(`datetime_${id}`).value;
            const checkType = document.getElementById(`check_type_${id}`).value;
            const attendance = document.getElementById(`attendance_${id}`).value;
            const attendanceType = document.getElementById(`attendance_type_${id}`).value;
            const isLate = document.querySelector(`#attendance-table-body tr:nth-child(${id}) td:nth-child(8)`).textContent.trim() === 'Yes' ? 1 : 0;

            fetch(`../update_record.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id, userId, datetime, checkType, attendance, attendanceType, isLate })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Record updated successfully!');
                } else {
                    alert('Failed to update record.');
                }
                fetchUserStatistics(); // Reload statistics to reflect changes
            })
            .catch(error => {
                console.error('Error updating record:', error);
            });
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                fetch(`../delete_record.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Record deleted successfully!');
                        fetchUserStatistics(); // Reload statistics to reflect changes
                    } else {
                        alert('Failed to delete record.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting record:', error);
                });
            }
        }

        fetchUserStatistics();
    </script>
</body>
</html>
